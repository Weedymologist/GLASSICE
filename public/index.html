<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlassICE // Interactive Chronicle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-color:#02040a;--glass-bg:rgba(10,20,40,0.6);--border-color:rgba(0,195,255,0.3);--primary-glow:rgba(0,195,255,0.7);--text-color:#e0e1f0;--primary-accent:#00c3ff;--user-accent:#00ffaa;--system-accent:#ffff00;--error-accent:#ff4136;--opponent-color:#ff99ff;--font-heading:'Orbitron',sans-serif;--font-body:'Roboto Mono',monospace}
        *{box-sizing:border-box;margin:0;padding:0}
        body{background-color:transparent;color:var(--text-color);font-family:var(--font-body);display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;overflow:hidden;}
        #background-canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;background-color:var(--bg-color);background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.05) 1px,transparent 0);background-size:20px 20px;background-position:center;transition:background-image 1s ease-in-out;}
        .image-cover { background-size: cover !important; }
        .screen{width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:center}
        .screen.active{display:flex}
        .hidden{display:none!important}
        .hub-container{text-align:center;animation:fadeIn 1s ease-in-out;padding:20px}
        .hub-header{margin-bottom:40px}
        .hub-header h1{font-family:var(--font-heading);color:var(--primary-accent);letter-spacing:4px;text-shadow:0 0 10px var(--primary-glow)}
        .hub-header h2{font-size:.9em;font-weight:400;color:var(--text-color);opacity:.7}
        .mode-selection button{display:block;margin:20px auto;width:350px;padding:20px;font-size:1.2em}
        .creation-container{width:100%;max-width:900px;background:var(--glass-bg);border:1px solid var(--border-color);border-radius:8px;padding:20px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);box-shadow:0 0 30px rgba(0,0,0,.5);animation:fadeIn 1s ease-in-out;max-height:100vh;overflow-y:auto}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:8px;color:var(--primary-accent);font-weight:700;font-size:.95em}
        textarea,select,input[type=text]{width:100%;padding:10px;background:rgba(0,0,0,.3);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95em;resize:vertical}
        .creation-footer{text-align:center;margin-top:20px}
        button{padding:10px 25px;background-color:transparent;color:var(--primary-accent);font-family:var(--font-heading);cursor:pointer;border:2px solid var(--primary-accent);font-size:1em;border-radius:4px;transition:all .2s ease;text-shadow:0 0 5px var(--primary-glow)}
        button:hover:not(:disabled){background-color:var(--primary-accent);color:var(--bg-color);box-shadow:0 0 20px var(--primary-glow)}
        button:disabled{opacity:.5;cursor:not-allowed}
        #genesis-screen{position:relative;width:100%;height:100%;display:flex;flex-direction:column;justify-content:flex-end;padding-bottom:150px}
        #loading-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;}
        .log-overlay{position:static;height:100%;width:100%;padding:20px;overflow-y:scroll;display:flex;flex-direction:column;justify-content:flex-end;}
        .log-entry{margin-bottom:10px;line-height:1.5;background:rgba(0,0,0,.4);padding:8px;border-radius:5px}
        .log-entry strong{font-weight:700;padding-right:8px;color:var(--primary-accent);display:inline}
        .log-entry strong.player-side{color:var(--user-accent)}
        .log-entry strong.opponent-side{color:var(--opponent-color)}
        .log-entry strong.system-info{color:var(--system-accent)}
        #competitive-input-overlay{position:absolute;bottom:0;left:0;right:0;padding:10px;display:flex;flex-direction:column;align-items:center;}
        .input-modal-competitive{display:flex;gap:10px;width:100%;max-width:900px;padding:15px;background:var(--glass-bg);border:1px solid var(--border-color);border-radius:8px;flex-direction:column;}
        .chat-form textarea{height:80px;font-size:1em;}
        .chat-form-buttons{display:flex;gap:8px;width:100%;justify-content:stretch}
        .chat-form-buttons button.icon-button{width:auto; flex-grow:0; padding:10px; display:flex; align-items:center; gap: 5px;}
    </style>
</head>
<body>
    <div id="background-canvas" class="image-cover"></div>
    <div id="hub-screen" class="screen active">
        <!-- Hub screen content is correct -->
    </div>
    <div id="genesis-screen" class="screen">
        <div class="log-overlay" id="chat-log-rpg"></div>
        <div id="loading-overlay" class="hidden">
            <!-- Loader content is correct -->
        </div>
    </div>
    <div id="creation-screen-rpg" class="screen hidden">
        <!-- Creation screen content is correct -->
    </div>
    <div id="competitive-input-overlay" class="hidden">
        <!-- Input overlay content is correct -->
        <div class="input-modal-competitive">
            <div class="player-side-input">
                <h3 id="player-side-label" style="color: var(--user-accent);">Player Side: Player</h3>
                <form id="chat-form-player-side" class="chat-form">
                    <textarea id="user-input-player-side" placeholder="Describe your actions or your side's strategy..." autocomplete="off"></textarea>
                    <div class="chat-form-buttons">
                        <button type="button" id="save-state-btn" class="icon-button" title="Save Game State"><span>üíæ</span> Save</button>
                        <button type="button" id="save-image-btn" class="icon-button" title="Save Current Image"><span>üñºÔ∏è</span> Save Image</button>
                        <button type="button" id="mic-btn-rpg" class="icon-button" title="Hold to Record Voice"><span>üé§</span></button>
                        <button type="submit" id="submit-turn-btn">Submit Turn</button>
                    </div>
                </form>
            </div>
            <!-- ... other input sections are correct -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // All variables and helper functions are correct from the last version.
            // ...

            function initializeUIAndData() {
                // ... (ui object initialization is correct)

                const submitTurnBtn = document.getElementById('submit-turn-btn'); // Make sure this is defined

                // --- THIS IS THE FIX ---
                // The event listener for the Submit Turn button.
                submitTurnBtn.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent form from submitting in the traditional way
                    if (dynamicGameState.gameOver) return;
                    
                    const playerMessage = ui.userInputPlayerSide.value.trim();
                    const opponentMessage = ui.userInputOpponentSide.value.trim();
                    
                    if (!playerMessage) {
                        alert("Please describe actions for your side.");
                        return;
                    }
                    if (dynamicGameState.gameMode === 'competitive' && !opponentMessage) {
                        alert("Please describe actions for the opponent side in competitive mode.");
                        return;
                    }
                    processTurnInput({ message: playerMessage, opponentMessage: opponentMessage });
                });
                
                // The rest of the initializeUIAndData function is correct...
                // ... (launchSandboxBtn listener, launchCompetitiveBtn listener, startBtn listener, etc.)
            }
            
            initializeUIAndData();
        });
    </script>
</body>
</html>
